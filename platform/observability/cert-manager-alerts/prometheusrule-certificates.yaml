apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: cert-manager-rules
  namespace: observability
  labels:
    release: kube-prometheus-stack
spec:
  groups:
    - name: cert-manager.rules
      rules:
        - alert: CertManagerCertificateExpiringSoon
          expr: (certmanager_certificate_expiration_timestamp_seconds - time()) < (14 * 24 * 60 * 60)
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "Certificate expiring soon"
            description: "Certificate {{ $labels.name }} in namespace {{ $labels.namespace }} expires within 14 days."

        - alert: CertManagerCertificateExpired
          expr: (certmanager_certificate_expiration_timestamp_seconds - time()) < 0
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "Certificate expired"
            description: "Certificate {{ $labels.name }} in namespace {{ $labels.namespace }} is expired."

        - alert: CertManagerNotReady
          expr: max by (pod) (kube_pod_container_status_ready{namespace="cert-manager"} == 0)
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "cert-manager pod not ready"
            description: "cert-manager has a container not ready for >10m."

        - alert: CertManagerIssuingErrors
          expr: increase(certmanager_controller_sync_total{result="error"}[10m]) > 0
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "cert-manager controller errors"
            description: "cert-manager has controller sync errors in the last 10 minutes."
